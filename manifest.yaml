version: 1

manifest:
  url: https://github.com/laynepenney/codi-gripspace.git
  linkfile:
    - src: CODI.md
      dest: CODI.md
    - src: CLAUDE.md
      dest: CLAUDE.md
    - src: AGENTS.md
      dest: AGENTS.md
    - src: envsetup.sh
      dest: envsetup.sh
    # OpenCode skill format
    - src: .opencode/skill/gitgrip
      dest: .opencode/skill/gitgrip
    - src: .opencode/skill/codi
      dest: .opencode/skill/codi
    - src: .opencode/skill/codi-rs
      dest: .opencode/skill/codi-rs
    # Codex skill format
    - src: .codex/skills/gitgrip
      dest: .codex/skills/gitgrip
    - src: .codex/skills/codi
      dest: .codex/skills/codi
    - src: .codex/skills/codi-rs
      dest: .codex/skills/codi-rs

repos:
  codi:
    url: https://github.com/laynepenney/codi.git
    path: ./codi
    default_branch: main
    linkfile:
      - src: .claude/skills/codi
        dest: .claude/skills/codi
    agent:
      description: "Codi AI coding wingman - TypeScript CLI with agent loop, tools, commands, and multiple AI providers"
      language: typescript
      build: "pnpm install && pnpm build"
      test: "pnpm test"
      lint: "pnpm build"
      format: "pnpm build"

  codi-rs:
    url: https://github.com/laynepenney/codi-rs.git
    path: ./codi-rs
    default_branch: main
    linkfile:
      - src: .claude/skills/codi-rs
        dest: .claude/skills/codi-rs
    agent:
      description: "Codi Rust port - terminal AI coding assistant with TUI, MCP support, and tree-sitter symbol index"
      language: rust
      build: "cargo build"
      test: "cargo test"
      lint: "cargo clippy"
      format: "cargo fmt"

  gitgrip:
    url: https://github.com/laynepenney/gitgrip.git
    path: ./gitgrip
    default_branch: main
    linkfile:
      - src: .claude/skills/gitgrip
        dest: .claude/skills/gitgrip
    agent:
      description: "Multi-repo workflow tool - synchronized branches, linked PRs, atomic merges across repositories"
      language: rust
      build: "cargo build"
      test: "cargo test"
      lint: "cargo clippy"
      format: "cargo fmt"

  # Reference implementations (read-only)
  opencode:
    url: https://github.com/anomalyco/opencode.git
    path: ./ref/opencode
    default_branch: dev
    reference: true

  aider:
    url: https://github.com/Aider-AI/aider.git
    path: ./ref/aider
    default_branch: main
    reference: true

  codex:
    url: https://github.com/openai/codex.git
    path: ./ref/codex
    default_branch: main
    reference: true

workspace:
  agent:
    description: "Codi workspace - multi-repo development environment for the Codi AI coding wingman (TypeScript + Rust) and gitgrip multi-repo tool"
    conventions:
      - "Always use `gr` for all git operations - never raw `git` or `gh` commands"
      - "All development on feature branches (feat/*, fix/*, chore/*) - never push to main"
      - "Use pull requests for all changes: `gr pr create -t 'title' --push`"
      - "Run `gr sync` before starting new work"
      - "TypeScript: ES Modules with .js extensions, async/await, Vitest for tests"
      - "Rust: anyhow for errors, tokio async runtime, cargo clippy before committing"
      - "Source envsetup.sh for shell functions: codi-build, codi-dev, codi-test, etc."
      - "Reference repos (ref/*) are read-only - for architecture patterns only"
      - "AI agents: use --json flag on gr commands (gr status --json, gr pr status --json, gr pr checks --json) for machine-readable output"
    workflows:
      build: "gr run build-all"
      test: "gr run test-all"
      dev-ts: "gr run dev-ts"
      dev-rs: "gr run dev-rs"
      sync: "gr sync"
      new-feature: "gr sync && gr branch feat/<name> && gr status"
      submit: "gr add . && gr commit -m '<message>' && gr push -u && gr pr create -t '<title>' --push"
      cleanup: "gr checkout --base && gr sync && gr prune --execute"

  scripts:
    # TypeScript codi
    build-ts:
      command: "cd codi && pnpm install && pnpm build"
      description: "Build codi (TypeScript)"
    dev-ts:
      command: "cd codi && pnpm dev"
      description: "Run codi TypeScript in dev mode"
    test-ts:
      command: "cd codi && pnpm test"
      description: "Run codi TypeScript tests"
    # Rust codi
    build-rs:
      command: "cd codi-rs && cargo build"
      description: "Build codi (Rust)"
    dev-rs:
      command: "cd codi-rs && cargo run"
      description: "Run codi Rust"
    test-rs:
      command: "cd codi-rs && cargo test"
      description: "Run codi Rust tests"
    # gitgrip
    build-gr:
      command: "cd gitgrip && cargo build"
      description: "Build gitgrip"
    test-gr:
      command: "cd gitgrip && cargo test"
      description: "Run gitgrip tests"
    # Combined
    build-all:
      command: "cd codi && pnpm install && pnpm build && cd ../codi-rs && cargo build && cd ../gitgrip && cargo build"
      description: "Build everything"
    test-all:
      command: "cd codi && pnpm test && cd ../codi-rs && cargo test && cd ../gitgrip && cargo test"
      description: "Run all tests"

settings:
  pr_prefix: "[cross-repo]"
  merge_strategy: all-or-nothing
